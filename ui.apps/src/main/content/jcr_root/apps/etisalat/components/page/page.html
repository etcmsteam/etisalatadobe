<!--/*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  ~ Copyright 2016 Adobe
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/-->
<!DOCTYPE HTML>
<html data-sly-use.page="com.adobe.cq.wcm.core.components.models.Page" lang="${page.language}"
  data-sly-use.pwa="com.adobe.cq.wcm.core.components.models.PWA" data-sly-use.head="head.html"
  data-sly-use.footer="footer.html" data-sly-use.redirect="redirect.html">

<head data-sly-call="${head.head @ page = page, pwa = pwa}"></head>
<title></title>
<sly data-sly-set.consumerTemplate="${properties['cq:template'] && 
         properties['cq:template'] == '/conf/etisalat/settings/wcm/templates/etisalat-consumer-content-page'}" />

<body
  class="${page.cssClassNames} ${pageProperties.hideHeader ? '' : (pageProperties.hideMegaMenu ? 'topnav--margin' : 'meganavigation--margin')}  ${consumerTemplate ? 'consumer__page' : '' }"
  dir="${page.language == 'ar' ? 'rtl' : 'ltr' }" id="${page.id}"
  data-cmp-data-layer-enabled="${page.data ? true : false}" data-page-title="${currentPage.title}">
  <script data-sly-test.dataLayerEnabled="${page.data}">
    const dataLayerEle = document.querySelector('body'),
      siteLangElement = document.querySelector('html'),
      serverName = window.location.hostname,
      dataLayerUrl = window.location.href
    pagePathName = window.location.pathname;
    dataLayerPathName = pagePathName.split('.html')[0],
    userAgentData = navigator.userAgent,
    currentDate = new Date(),
    previousPage = document.referrer,
    previousPageName = '',
    siteSection = '';
    siteSection1 = '',
    siteSection2 = '';
    siteSecMicrosites = '';

    let siteLang = siteLangElement.getAttribute('lang'),
      pageTitle = dataLayerEle.dataset.pageTitle.toLowerCase(),
      pageName;

    let dateStr = currentDate.toString();
    let index = dateStr.lastIndexOf(':') + 3;
    currentDate = dateStr.substring(0, index);
    
    //sitesection 1 and 2
    const pathArr = dataLayerPathName.split('/');
    if(pathArr.length >= 3) {
      const newPathArr = pathArr.slice(-3);
      siteSection = newPathArr[0];
      siteSection1 = newPathArr[1];
      siteSection2 = newPathArr[2];
    }

    function isValidHttpUrl(string) {
      try {
        return new URL(string);
      } catch (e) {
        return false;
      }
    }
 
    if (isValidHttpUrl(previousPage)) {
      previousPage = isValidHttpUrl(previousPage).pathname;
      var arr = previousPage.split('/');
      var lastItem = arr.pop();
      previousPageName = lastItem.split('.')[0];
    }

    if (serverName.includes('ewallet.ae')) {
      if (dataLayerPathName.includes('/personal/')) {
        populatePageName('personal:home');
      } else if (dataLayerPathName.includes('/business/')) {
        populatePageName('business:home');
      } else {
        populatePageName('personal:home');
      }
    } else {
      populatePageName('home');
    }

    //sitesection changes
    if (serverName.includes('ewallet.ae')) {
      if (pagePathName.includes('/personal/')) {
        siteSecMicrosites = "personal";
      } else if (pagePathName.includes('/business/')) {
        siteSecMicrosites = "business";
      } else if (pagePathName.includes('/aboutus/')) {
        siteSecMicrosites = "aboutus";
      } else if (pagePathName.includes('/faq/')) {
        siteSecMicrosites = "faq";
      } else if (pagePathName.includes('/locations/')) {
        siteSecMicrosites = "locations";
      } else if (pagePathName.includes('/offer/')) {
        siteSecMicrosites = "offer";
      } else if (pagePathName === '/') {
        siteSecMicrosites = "personal";
      }
    } else if (serverName.includes('hiuapp.ae')) {
      siteSecMicrosites = "home";
      if (pagePathName.includes('terms_conditions')) {
        siteSecMicrosites = "t&c";
      }
    } else if (serverName.includes('fivemobile.ae')) {
      siteSecMicrosites = "home";
    }

    if (siteLang.includes("-")) {
      let langArr = [];
      langArr = siteLang.split("-");
      siteLang = langArr[0];
    }
    pageName = siteLang + '-ae:' + pageTitle;

    function populatePageName(title) {
      let lastSegment = dataLayerPathName.split('/').pop();
      if (lastSegment === 'index' || pagePathName === "/") {
        pageTitle = title;
      }
    }

    function urlExists(url) {
      var http = new XMLHttpRequest();
      http.open('HEAD', url, false);
      http.send();
      if (http.status != 404)
        return false;
      else
        return true;
    };

    const isErrorFlg = urlExists(dataLayerUrl);
    if(!serverName.includes('etisalat.ae')) {
    window.adobeDataLayer = window.adobeDataLayer || [];
    adobeDataLayer.push({
      "event": "pageLoaded",
      "xdmPageLoad": {
        "web": {
          "webPageDetails": {
            "name": pageName,
            "server": serverName,
            "siteSection": siteSecMicrosites,
            "isErrorPage": isErrorFlg,
            "URL": dataLayerUrl,
            "pageViews": {
              "value": 1
            }
          }
        }
      }
    });
    } else {
      window.onload = function () {
        var loadTime = window.performance.timing.domContentLoadedEventEnd-window.performance.timing.navigationStart;
        loadTime = loadTime/1000 + 's';

      if(!isErrorFlg){
        adobeDataLayer.push({
          "event": "pageLoaded",
          "xdmPageLoad": {
            "web": {
              "webPageDetails": {
                "name": pageName,
                "server": serverName,
                "siteSection": siteSection,
                "siteSection1": siteSection1,
                "siteSection2": siteSection2,
                "isErrorPage": isErrorFlg,
                "URL": dataLayerUrl,
                "pageViews": {
                  "value": 1
                }
              }
            },
            "pageInfo": {
              "country": "ae",
              "language": siteLang,
              "previousPageName": previousPageName,
              "referrer": previousPage, 
              "pageType": pageTitle,
              "pageLoadTime": loadTime
            },
            "user": {
              "loginStatus": "logged-out"
            },
            "timestamp": currentDate.toString(),
            "userAgentString": userAgentData
          }
        });
        }
        else{
          adobeDataLayer.push({
          event:"errorInteraction",
          "xdmPageLoad": {
            "web": {
              "webPageDetails": {
                "name": pageName,
                "server": serverName,
                "siteSection": siteSection,
                "siteSection1": siteSection1,
                "siteSection2": siteSection2,
                "isErrorPage": isErrorFlg,
                "URL": dataLayerUrl,
                "pageViews": {
                  "value": 1
                }
              }
            },
            "pageInfo": {
              "country": "ae",
              "language": siteLang,
              "previousPageName": previousPageName,
              "referrer": previousPage, 
              "pageType": pageTitle,
              "pageLoadTime": loadTime
            },
            "user": {
              "loginStatus": "logged-out"
            },
            "timestamp": currentDate.toString(),
            "userAgentString": userAgentData,
            errorInfo:{
                error:1,
                errorMessage: 'page not found',
                errorCode: "404",
                errorType:"page load Error"
             }
          }
        });
      }
     }
    }
  </script>
  <!--For Google Map-->
  <script>
    (function (window) {
      // general configuration settings
      window.appConfig = {
        maps: {
          center: { // Dubai Position
            lat: 25.208549,
            lng: 55.271945
          },
          range: 10,
          customMarkerBaseUrl: '/content/dam/ewallet/maps/'
        }
      };
    }(window));
  </script>
  <!--For Google Map End-->
  <sly data-sly-test.isRedirectPage="${page.redirectTarget && (wcmmode.edit || wcmmode.preview)}"
    data-sly-call="${redirect.redirect @ redirectTarget = page.redirectTarget}"></sly>
  <sly data-sly-test="${!isRedirectPage}">
    <sly data-sly-include="body.skiptomaincontent.html"></sly>
    <sly data-sly-include="body.socialmedia_begin.html"></sly>
    <sly data-sly-include="body.html"></sly>
    <sly data-sly-call="${footer.footer @ page = page, pwa = pwa}"></sly>
    <sly data-sly-include="body.socialmedia_end.html"></sly>
  </sly>
</body>

</html>